<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registo de Sessões e Frequência</title>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        form input[type="text"], form input[type="date"], form select { 
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; 
            border-radius: 4px; box-sizing: border-box; display: block;
        }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .tabela-frequencia td { text-align: center; }
    </style>
</head>
<body>

    <a href="/index.html" style="text-decoration: none;"><button style="background-color: #555;">← Voltar ao Menu</button></a>
    <div class="section">
        <h1>Registo de Sessões e Frequência</h1>

        <form id="form-sessao">
            <h2>1. Dados da Sessão</h2>
            <label for="data-sessao">Data da Sessão:</label>
            <input type="date" id="data-sessao" required>
            
            <label for="tipo-sessao">Tipo/Nome da Sessão:</label>
            <input type="text" id="tipo-sessao" required>
            
            <label for="grau-sessao-requerido">Grau Mínimo Requerido:</label>
            <select id="grau-sessao-requerido" required>
                <option value="">A carregar Graus...</option>
            </select>
            
            <button type="submit">Criar Sessão e Marcar Frequência</button>
        </form>

        <div id="frequencia-form" style="display:none; margin-top: 20px;">
            <h2>2. Marcar Frequência</h2>
            <h3>Sessão: <span id="sessao-data-display"></span></h3>
            <form id="form-frequencia">
                <table id="tabela-frequencia" class="tabela-frequencia">
                    <thead>
                        <tr><th>Nome do Irmão</th><th>Presença</th><th>Falta</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" onclick="salvarFrequencia()">Salvar Frequência</button>
            </form>
        </div>

        <h3>Sessões Registradas</h3>
        <table id="tabela-sessoes">
            <thead>
                <tr><th>Data</th><th>Tipo</th><th>Ações</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCk-L6r_p9SPxx_WmuPnzEMcEAlDfLlbJk",
          authDomain: "gestao-maconica.firebaseapp.com",
          projectId: "gestao-maconica",
          storageBucket: "gestao-maconica.firebasestorage.app",
          messagingSenderId: "57851106083",
          appId: "1:57851106083:web:0572445f0f856d22347296",
          measurementId: "G-F1ZZ7XB7DQ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); 

        let membros = [];
        let graus = [];
        let sessoes = [];
        let sessaoAtualParaFrequencia = null;


        // --- FUNÇÕES DE CARREGAMENTO E MÓDULO DE SESSÕES ---

        // Carrega a lista global de graus (necessário para o dropdown)
        function carregarGrausParaSessao() {
             db.collection("graus").orderBy("numero", "asc").get().then((snapshot) => {
                graus = [];
                snapshot.forEach((doc) => {
                    graus.push({ id: doc.id, ...doc.data() });
                });
                popularGrausDropdownSessao();
                carregarMembrosESessoes();
            });
        }
        
        function popularGrausDropdownSessao() {
            const selectGrau = document.getElementById('grau-sessao-requerido');
            selectGrau.innerHTML = ''; 
            selectGrau.appendChild(new Option('Selecione o Grau Requerido', '')); 
            
            graus.forEach((g) => {
                const option = new Option(`${g.numero} - ${g.nome}`, g.numero);
                selectGrau.appendChild(option);
            });
        }

        function carregarMembrosESessoes() {
            db.collection("membros").get().then((snapshotMembros) => {
                membros = [];
                snapshotMembros.forEach((doc) => {
                    membros.push({ id: doc.id, ...doc.data() });
                });

                db.collection("sessoes").orderBy("data", "desc").onSnapshot((snapshotSessoes) => {
                    sessoes = [];
                    snapshotSessoes.forEach((doc) => { sessoes.push({ id: doc.id, ...doc.data() }); });
                    exibirSessoes();
                });
            });
        }
        
        document.getElementById('form-sessao').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = document.getElementById('data-sessao').value;
            const tipo = document.getElementById('tipo-sessao').value;
            const grauRequeridoNumero = parseInt(document.getElementById('grau-sessao-requerido').value, 10);
            
            if (isNaN(grauRequeridoNumero)) {
                alert('Selecione um Grau Mínimo Requerido.');
                return;
            }

            sessaoAtualParaFrequencia = { data, tipo, grau_requerido: grauRequeridoNumero, frequencia: {} };
            prepararFormularioFrequencia(sessaoAtualParaFrequencia);
        });

        function prepararFormularioFrequencia(sessao) {
            
            const grauRequerido = sessao.grau_requerido;
            
            const membrosElegiveis = membros.filter(m => {
                return m.numero_grau && m.numero_grau >= grauRequerido;
            });
            
            if (membrosElegiveis.length === 0) { 
                alert('Nenhum irmão é elegível para esta sessão.'); 
                document.getElementById('form-sessao').style.display = 'block';
                return; 
            }

            document.getElementById('sessao-data-display').textContent = `${sessao.data} (${sessao.tipo} - Grau Mínimo: ${grauRequerido})`;
            const tbodyFrequencia = document.getElementById('tabela-frequencia').getElementsByTagName('tbody')[0];
            tbodyFrequencia.innerHTML = ''; 

            membrosElegiveis.forEach(m => {
                const row = tbodyFrequencia.insertRow();
                row.insertCell().textContent = `${m.nome} (G: ${m.numero_grau})`;
                const cellPresenca = row.insertCell();
                const inputPresenca = document.createElement('input');
                inputPresenca.type = 'radio'; inputPresenca.name = 'frequencia_' + m.matricula; inputPresenca.value = 'presente'; inputPresenca.checked = true;
                cellPresenca.appendChild(inputPresenca);
                const cellFalta = row.insertCell();
                const inputFalta = document.createElement('input');
                inputFalta.type = 'radio'; inputFalta.name = 'frequencia_' + m.matricula; inputFalta.value = 'ausente';
                cellFalta.appendChild(inputFalta);
            });

            document.getElementById('frequencia-form').style.display = 'block';
            document.getElementById('form-sessao').style.display = 'none';
        }

        function salvarFrequencia() {
            const formFrequencia = document.getElementById('form-frequencia');
            membros.forEach(m => {
                const radios = formFrequencia.elements['frequencia_' + m.matricula];
                if (radios) { 
                     sessaoAtualParaFrequencia.frequencia[m.matricula] = (radios.value === 'presente');
                }
            });

            db.collection("sessoes").add(sessaoAtualParaFrequencia)
                .then(() => { alert('Frequência salva!'); 
                    document.getElementById('frequencia-form').style.display = 'none';
                    document.getElementById('form-sessao').style.display = 'block';
                    document.getElementById('form-sessao').reset();
                })
                .catch((error) => { console.error(error); alert("Erro ao salvar frequência."); });
        }

        function exibirSessoes() {
            const tbody = document.getElementById('tabela-sessoes').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; 
            sessoes.forEach(s => {
                const row = tbody.insertRow();
                row.insertCell().textContent = s.data;
                row.insertCell().textContent = s.tipo + (s.grau_requerido ? ` (Grau Mínimo: ${s.grau_requerido})` : '');
                row.insertCell().textContent = 'Completo'; 
            });
        }


        // --- CHECAGEM DE AUTENTICAÇÃO ---

        auth.onAuthStateChanged((user) => {
            if (user) {
                carregarGrausParaSessao(); // Inicia o carregamento dos dados se logado
            } else {
                window.location.href = "/index.html";
            }
        });

    </script>
</body>
</html>