<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Maçônica - Completo - v.2</title>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    
    <style>
        /* Estilos de layout e login */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .section-content { 
            background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-top: 20px; max-width: 900px; margin-left: auto; margin-right: auto;
        }
        .menu-button { 
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            background-color: #007bff; color: white; border: none; border-radius: 4px; 
            cursor: pointer; text-align: left; font-size: 1.1em; text-decoration: none;
        }
        .menu-button:hover { background-color: #0056b3; }
        #login-screen { 
            max-width: 400px; margin: 100px auto; padding: 20px; background-color: #fff; 
            border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        form input[type="text"], form input[type="password"], form input[type="number"], form input[type="date"], form select { 
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; 
            border-radius: 4px; box-sizing: border-box; display: block;
        }
        button { 
            background-color: #007bff; color: white; padding: 10px 15px; 
            border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; 
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .tabela-frequencia td { text-align: center; }
        
        /* CSS que controla a visibilidade (Esconde o app e o login no carregamento) */
        #main-content, #login-screen { 
            display: none; 
        }
    </style>
</head>
<body>
    
    <div id="initial-loading" style="text-align: center; margin-top: 50px;">
        <h2>A carregar sistema...</h2>
    </div>

    <div id="login-screen">
        <h2>Acesso ao Sistema Maçônico</h2>
        <p>Use o botão "Criar Nova Conta" APENAS na primeira vez.</p>
        <form id="form-login">
            <label for="login-email">Email:</label>
            <input type="text" id="login-email" required>
            
            <label for="login-password">Senha:</label>
            <input type="password" id="login-password" required>
            
            <button type="button" onclick="fazerLogin()">Entrar</button>
            <button type="button" onclick="criarConta()">Criar Nova Conta</button>
            <p id="login-status" style="color:red; margin-top: 10px;"></p>
        </form>
    </div>

    <div id="main-content">
        
        <button onclick="fazerLogout()" style="float: right; background-color: #333; margin-bottom: 20px;">Sair</button>

        <h1>Sistema de Gestão Maçônica - Arquivo Único</h1>
        
        <div style="margin-bottom: 20px;">
            <button onclick="showSection('menu')">Menu Principal</button>
            <button onclick="showSection('graus')">Gestão de Graus</button>
            <button onclick="showSection('irmaos')">Cadastro de Irmãos</button>
            <button onclick="showSection('sessoes')">Registo de Sessões</button>
            <button onclick="showSection('relatorios')">Relatórios</button>
        </div>

        <div id="menu-section" class="section-content">
            <h2>Menu Principal</h2>
            <p>Selecione uma opção para gerir os dados:</p>
        </div>

        <div id="graus-section" class="section-content" style="display:none;">
            <h2>Gestão de Graus Maçônicos</h2>

            <form id="form-grau">
                <label for="numero-grau">Número/Ordem do Grau:</label>
                <input type="number" id="numero-grau" required min="1" value="1"> 
                
                <label for="nome-grau">Nome do Grau:</label>
                <input type="text" id="nome-grau" required>
                
                <button type="submit">Adicionar Grau</button>
            </form>

            <h3>Graus Cadastrados</h3>
            <table id="tabela-graus">
                <thead>
                    <tr><th>Nº</th><th>Nome do Grau</th><th>Ações</th></tr> 
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="irmaos-section" class="section-content" style="display:none;">
            <h2>Cadastro de Irmãos</h2>
            <form id="form-membro">
                <label for="nome">Nome Completo:</label>
                <input type="text" id="nome" required>
                
                <label for="matricula">Matrícula (Única):</label>
                <input type="text" id="matricula" required>
                
                <label for="grau">Grau:</label>
                <select id="grau">
                    <option value="">A carregar Graus...</option>
                </select>
                
                <button type="submit">Cadastrar Irmão</button>
            </form>

            <h3>Lista de Irmãos Cadastrados</h3>
            <table id="tabela-membros">
                <thead>
                    <tr><th>Matrícula</th><th>Nome</th><th>Grau</th><th>Ações</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="sessoes-section" class="section-content" style="display:none;">
            <h2>Registo de Sessão e Frequência</h2>
            <form id="form-sessao">
                <label for="data-sessao">Data da Sessão:</label>
                <input type="date" id="data-sessao" required>
                
                <label for="tipo-sessao">Tipo/Nome da Sessão:</label>
                <input type="text" id="tipo-sessao" required>
                
                <button type="submit">Criar Sessão e Marcar Frequência</button>
            </form>

            <div id="frequencia-form" style="display:none; margin-top: 20px;">
                <h3>Marcar Frequência (Data: <span id="sessao-data-display"></span>)</h3>
                <form id="form-frequencia">
                    <table id="tabela-frequencia" class="tabela-frequencia">
                        <thead>
                            <tr><th>Nome do Irmão</th><th>Presença</th><th>Falta</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" onclick="salvarFrequencia()">Salvar Frequência</button>
                </form>
            </div>

            <h3>Sessões Registradas</h3>
            <table id="tabela-sessoes">
                <thead>
                    <tr><th>Data</th><th>Tipo</th><th>Ações</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="relatorios-section" class="section-content" style="display:none;">
            <h2>Relatórios de Frequência</h2>
            
            <button onclick="carregarDadosEGerarRelatorio()">Gerar Relatório de Frequência</button>
            
            <table id="tabela-relatorio" style="margin-top: 20px;">
                <thead>
                    <tr><th>Matrícula</th><th>Nome</th><th>Grau</th><th>Presenças</th><th>Total de Sessões</th><th>% Frequência</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>


    </div> <script>
        /* Documentação JavaScript: Lógica Completa e Consolidada */
        
        // --- 1. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCk-L6r_p9SPxx_WmuPnzEMcEAlDfLlbJk",
          authDomain: "gestao-maconica.firebaseapp.com",
          projectId: "gestao-maconica",
          storageBucket: "gestao-maconica.firebasestorage.app",
          messagingSenderId: "57851106083",
          appId: "1:57851106083:web:0572445f0f856d22347296",
          measurementId: "G-F1ZZ7XB7DQ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); 

        let membros = [];
        let graus = [];
        let sessoes = [];
        let sessaoAtualParaFrequencia = null;


        /* --- 2. GESTÃO DE TELAS E NAVEGAÇÃO INTERNA --- */

        // Função para mostrar a seção correta e esconder as outras
        function showSection(sectionId) {
            const sections = ['menu', 'graus', 'irmaos', 'sessoes', 'relatorios'];
            sections.forEach(id => {
                const element = document.getElementById(id + '-section');
                if (element) {
                    element.style.display = (id === sectionId) ? 'block' : 'none';
                }
            });

            // Ações específicas ao abrir a seção:
            if (sectionId === 'irmaos') {
                popularGrausEcarregarMembros(); // Atualiza dropdown e lista
            } else if (sectionId === 'sessoes') {
                carregarMembrosESessoes(); // Atualiza lista de sessões e prepara frequência
            }
        }

        // Funções para exibição da tela principal
        function mostrarApp() {
            document.getElementById('initial-loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('login-screen').style.display = 'none';
            showSection('menu'); // Inicia mostrando o menu
        }

        function mostrarLogin() {
            document.getElementById('initial-loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
        }

        /*