<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro e Gestão de Irmãos</title>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        form input[type="text"], form input[type="number"], form select { 
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; 
            border-radius: 4px; box-sizing: border-box; display: block;
        }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <a href="/index.html" style="text-decoration: none;"><button style="background-color: #555;">← Voltar ao Menu</button></a>
    <div class="section">
        <h1>Gestão de Irmãos Maçônicos</h1>
        
        <form id="form-membro">
            <h2>1. Cadastro de Irmãos</h2>
            <label for="nome">Nome Completo:</label>
            <input type="text" id="nome" required>
            
            <label for="matricula">Matrícula (Única):</label>
            <input type="text" id="matricula" required>
            
            <label for="grau">Grau:</label>
            <select id="grau">
                <option value="">A carregar Graus...</option>
            </select>
            
            <button type="submit">Cadastrar Irmão</button>
        </form>

        <h3>Lista de Irmãos Cadastrados</h3>
        <table id="tabela-membros">
            <thead>
                <tr><th>Matrícula</th><th>Nome</th><th>Grau</th><th>Ações</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCk-L6r_p9SPxx_WmuPnzEMcEAlDfLlbJk",
          authDomain: "gestao-maconica.firebaseapp.com",
          projectId: "gestao-maconica",
          storageBucket: "gestao-maconica.firebasestorage.app",
          messagingSenderId: "57851106083",
          appId: "1:57851106083:web:0572445f0f856d22347296",
          measurementId: "G-F1ZZ7XB7DQ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); 

        let membros = [];
        let graus = [];
        
        // --- FUNÇÕES DE CARREGAMENTO ---
        
        // Carrega a lista global de graus (necessário para o dropdown)
        function carregarGrausParaIrmaos() {
             db.collection("graus").orderBy("numero", "asc").get().then((snapshot) => {
                graus = [];
                snapshot.forEach((doc) => {
                    graus.push({ id: doc.id, ...doc.data() });
                });
                popularGrausDropdownMembro();
                carregarMembros();
            });
        }

        // Popula o dropdown de Cadastro de Irmãos
        function popularGrausDropdownMembro() {
            const selectGrau = document.getElementById('grau');
            selectGrau.innerHTML = ''; 
            selectGrau.appendChild(new Option('Selecione o Grau', '')); 
            
            graus.forEach((g) => {
                const option = new Option(`${g.numero} - ${g.nome}`, g.numero);
                option.setAttribute('data-nome', g.nome); 
                selectGrau.appendChild(option);
            });
        }

        function carregarMembros() {
            db.collection("membros").onSnapshot((snapshot) => {
                membros = [];
                snapshot.forEach((doc) => {
                    membros.push({ id: doc.id, ...doc.data() });
                });
                exibirMembros();
            });
        }

        // --- FUNÇÕES DE CRUD ---

        document.getElementById('form-membro').addEventListener('submit', function(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value;
            const matricula = document.getElementById('matricula').value.trim();
            
            const selectGrau = document.getElementById('grau');
            const numeroGrau = parseInt(selectGrau.value, 10); 
            const nomeGrau = selectGrau.options[selectGrau.selectedIndex].getAttribute('data-nome'); 
            
            db.collection("membros").add({ matricula, nome, nome_grau: nomeGrau, numero_grau: numeroGrau })
                .then(() => { alert(`Irmão ${nome} cadastrado com Grau ${nomeGrau}!`); this.reset(); })
                .catch((error) => { alert("Erro ao salvar o Irmão."); console.error(error); });
        });
        
        function exibirMembros() {
            const tbody = document.getElementById('tabela-membros').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; 
            membros.forEach(m => {
                const row = tbody.insertRow();
                row.insertCell().textContent = m.matricula;
                row.insertCell().textContent = m.nome;
                row.insertCell().textContent = m.nome_grau || m.grau || 'N/A';
                const cellAcoes = row.insertCell(); 
                const btnExcluir = document.createElement('button');
                btnExcluir.textContent = 'Excluir';
                btnExcluir.style.backgroundColor = '#dc3545';
                btnExcluir.onclick = () => excluirMembro(m.id, m.nome);
                cellAcoes.appendChild(btnExcluir);
            });
        }
        
        function excluirMembro(membroId, nomeMembro) {
             if (!confirm(`Excluir o irmão ${nomeMembro}?`)) return;
             db.collection("membros").doc(membroId).delete().then(() => { alert(`Irmão ${nomeMembro} excluído!`); });
        }


        // --- CHECAGEM DE AUTENTICAÇÃO ---

        auth.onAuthStateChanged((user) => {
            if (user) {
                carregarGrausParaIrmaos(); // Inicia o carregamento dos dados se logado
            } else {
                window.location.href = "/index.html";
            }
        });

    </script>
</body>
</html>