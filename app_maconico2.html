<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Maçônica - Protegido</title>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    
    <style>
        /* Documentação CSS: Estilos básicos para organização e usabilidade */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1 1 300px; }
        form label { display: block; margin: 10px 0 5px; font-weight: bold; }
        form input[type="text"], form input[type="date"], form select, form input[type="password"] { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .tabela-frequencia td { text-align: center; }

        /* NOVO: Estilos de Login */
        #login-screen { 
            max-width: 400px; 
            margin: 100px auto; 
            padding: 20px; 
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        /* CRUCIAL: A aplicação começa escondida */
        #app-content { 
            display: none; 
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>Acesso ao Sistema Maçônico</h2>
        <form id="form-login">
            <label for="login-email">Email:</label>
            <input type="text" id="login-email" required>
            
            <label for="login-password">Senha:</label>
            <input type="password" id="login-password" required>
            
            <button type="button" onclick="fazerLogin()">Entrar</button>
            <button type="button" onclick="criarConta()">Criar Nova Conta</button>
            <p id="login-status" style="color:red; margin-top: 10px;"></p>
        </form>
    </div>

    <div id="app-content">
        
        <button onclick="fazerLogout()" style="float: right; background-color: #333; margin-bottom: 20px;">Sair</button>

        <h1>Sistema de Gestão Maçônica - Firebase</h1>
        
        <div class="container">
            
            <div class="section" id="cadastro-membros">
                <h2>1. Cadastro de Irmãos</h2>
                <form id="form-membro">
                    <label for="nome">Nome Completo:</label>
                    <input type="text" id="nome" required>
                    
                    <label for="matricula">Matrícula (Única):</label>
                    <input type="text" id="matricula" required>
                    
                    <label for="grau">Grau:</label>
                    <select id="grau">
                        <option value="Aprendiz">Aprendiz</option>
                        <option value="Companheiro">Companheiro</option>
                        <option value="Mestre">Mestre</option>
                    </select>
                    
                    <button type="submit">Cadastrar Irmão</button>
                </form>

                <h3>Lista de Irmãos Cadastrados</h3>
                <table id="tabela-membros">
                    <thead>
                        <tr>
                            <th>Matrícula</th>
                            <th>Nome</th>
                            <th>Grau</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

            <div class="section" id="cadastro-sessoes">
                <h2>2. Registo de Sessão e Frequência</h2>
                <form id="form-sessao">
                    <label for="data-sessao">Data da Sessão:</label>
                    <input type="date" id="data-sessao" required>
                    
                    <label for="tipo-sessao">Tipo/Nome da Sessão:</label>
                    <input type="text" id="tipo-sessao" required>
                    
                    <button type="submit">Criar Sessão e Marcar Frequência</button>
                </form>

                <div id="frequencia-form" style="display:none; margin-top: 20px;">
                    <h3>Marcar Frequência (Data: <span id="sessao-data-display"></span>)</h3>
                    <form id="form-frequencia">
                        <table id="tabela-frequencia" class="tabela-frequencia">
                            <thead>
                                <tr><th>Nome do Irmão</th><th>Presença</th><th>Falta</th></tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" onclick="salvarFrequencia()">Salvar Frequência</button>
                    </form>
                </div>

                <h3>Sessões Registradas</h3>
                <table id="tabela-sessoes">
                    <thead>
                        <tr><th>Data</th><th>Tipo</th><th>Ações</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
            <div class="section" id="relatorios">
                <h2>3. Relatórios de Frequência</h2>
                
                <button onclick="gerarRelatorioFrequencia()">Gerar Relatório de Frequência</button>
                
                <table id="tabela-relatorio" style="margin-top: 20px;">
                    <thead>
                        <tr><th>Matrícula</th><th>Nome</th><th>Grau</th><th>Presenças</th><th>Total de Sessões</th><th>% Frequência</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

        </div> </div> <script>
        /* Documentação JavaScript: Lógica Completa (Autenticação, CRUD e Relatórios) */
        
        // --- 1. CONFIGURAÇÃO DO FIREBASE ---

        // ⚠️ ATENÇÃO: SUBSTITUA ESTE BLOCO PELAS SUAS CHAVES DO FIREBASE!
const firebaseConfig = {
  apiKey: "AIzaSyCk-L6r_p9SPxx_WmuPnzEMcEAlDfLlbJk",
  authDomain: "gestao-maconica.firebaseapp.com",
  projectId: "gestao-maconica",
  storageBucket: "gestao-maconica.firebasestorage.app",
  messagingSenderId: "57851106083",
  appId: "1:57851106083:web:0572445f0f856d22347296",
  measurementId: "G-F1ZZ7XB7DQ"
};

        // Inicializa o Firebase e as Referências
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // Referência para Autenticação

        // --- VARIÁVEIS GLOBAIS ---
        let membros = [];
        let sessoes = [];
        let sessaoAtualParaFrequencia = null;


        /* --- 2. GESTÃO DE AUTENTICAÇÃO (LOGIN/LOGOUT) --- */

        // Funções para Esconder/Mostrar as Telas (NOVO)
        function mostrarApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            carregarDados(); // Começa a carregar os dados APENAS após o login
        }

        function mostrarLogin() {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
        }

        // Criar uma Nova Conta (NOVO)
        function criarConta() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    alert('Conta criada com sucesso! Pode iniciar sessão.');
                    document.getElementById('login-status').textContent = '';
                })
                .catch((error) => {
                    document.getElementById('login-status').textContent = 'Erro ao criar conta: ' + error.message;
                    console.error('Erro ao criar conta:', error);
                });
        }
        
        // Fazer Login (NOVO)
        function fazerLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    // O listener auth.onAuthStateChanged trata de mostrar a aplicação.
                    document.getElementById('login-status').textContent = 'Login bem-sucedido. A carregar...';
                })
                .catch((error) => {
                    document.getElementById('login-status').textContent = 'Erro no Login: Email ou senha inválidos.';
                    console.error('Erro no Login:', error);
                });
        }
        
        // Fazer Logout (NOVO)
        function fazerLogout() {
            auth.signOut()
                .then(() => {
                    document.getElementById('login-status').textContent = 'Sessão encerrada.';
                })
                .catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                });
        }

        // VERIFICAÇÃO PRINCIPAL: Monitorizar o estado da autenticação (CRUCIAL)
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Usuário está logado
                mostrarApp(); 
            } else {
                // Usuário deslogado
                mostrarLogin(); 
            }
        });


        /* --- 3. GESTÃO DE DADOS (CARREGAR/CRUD) --- */

        // Carregar dados do Firebase (real-time listeners)
        function carregarDados() {
            // Documentação: Escuta as mudanças na coleção 'membros' em tempo real
            db.collection("membros").onSnapshot((snapshot) => {
                membros = [];
                snapshot.forEach((doc) => {
                    membros.push({ id: doc.id, ...doc.data() });
                });
                exibirMembros(); 
            }, (error) => {
                console.error("Erro ao carregar membros: ", error);
            });

            // Documentação: Escuta as mudanças na coleção 'sessoes' em tempo real, ordenado pela data
            db.collection("sessoes").orderBy("data", "desc").onSnapshot((snapshot) => {
                sessoes = [];
                snapshot.forEach((doc) => {
                    sessoes.push({ id: doc.id, ...doc.data() });
                });
                exibirSessoes(); 
            }, (error) => {
                console.error("Erro ao carregar sessões: ", error);
            });
        }

        // Evento de submissão do formulário de membros
        document.getElementById('form-membro').addEventListener('submit', function(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value;
            const matricula = document.getElementById('matricula').value.trim();
            const grau = document.getElementById('grau').value;

            if (membros.some(m => m.matricula === matricula)) {
                alert('Erro: Já existe um membro com esta matrícula!');
                return;
            }

            const novoMembro = { matricula, nome, grau };
            
            db.collection("membros").add(novoMembro)
                .then(() => {
                    alert(`Irmão ${nome} cadastrado no Firebase com sucesso!`);
                    this.reset();
                })
                .catch((error) => {
                    console.error("Erro ao adicionar documento: ", error);
                    alert("Erro ao salvar o Irmão.");
                });
        });

        // Função para exibir a lista de membros na tabela (Com botão Excluir)
        function exibirMembros() {
            const tbody = document.getElementById('tabela-membros').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; 
            
            membros.forEach(m => {
                const row = tbody.insertRow();
                row.insertCell().textContent = m.matricula;
                row.insertCell().textContent = m.nome;
                row.insertCell().textContent = m.grau;

                const cellAcoes = row.insertCell(); 
                
                const btnExcluir = document.createElement('button');
                btnExcluir.textContent = 'Excluir';
                btnExcluir.style.backgroundColor = '#dc3545'; 
                btnExcluir.onclick = () => excluirMembro(m.id, m.nome); // Chama a função de exclusão
                
                cellAcoes.appendChild(btnExcluir);
            });
        }
        
        // FUNÇÃO DE EXCLUSÃO DE MEMBRO
        function excluirMembro(membroId, nomeMembro) {
            if (!confirm(`Tem certeza que deseja EXCLUIR o irmão ${nomeMembro}? Esta ação é irreversível!`)) {
                return;
            }

            db.collection("membros").doc(membroId).delete()
                .then(() => {
                    alert(`Irmão ${nomeMembro} excluído do sistema!`);
                })
                .catch((error) => {
                    console.error("Erro ao remover o membro: ", error);
                    alert(`Erro ao tentar excluir o irmão ${nomeMembro}.`);
                });
        }

        /* --- 4. GESTÃO DE SESSÕES E FREQUÊNCIA --- */

        // Evento de submissão do formulário de sessão
        document.getElementById('form-sessao').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = document.getElementById('data-sessao').value;
            const tipo = document.getElementById('tipo-sessao').value;

            const novaSessao = {
                data: data,
                tipo: tipo,
                frequencia: {} 
            };

            sessaoAtualParaFrequencia = novaSessao;
            
            prepararFormularioFrequencia(novaSessao);
        });

        // Função para preparar o formulário de frequência
        function prepararFormularioFrequencia(sessao) {
            if (membros.length === 0) {
                alert('É necessário cadastrar irmãos primeiro para marcar a frequência.');
                return;
            }

            document.getElementById('sessao-data-display').textContent = sessao.data + ' (' + sessao.tipo + ')';
            const tbodyFrequencia = document.getElementById('tabela-frequencia').getElementsByTagName('tbody')[0];
            tbodyFrequencia.innerHTML = '';

            membros.forEach(membro => {
                const row = tbodyFrequencia.insertRow();
                row.insertCell().textContent = membro.nome;

                const cellPresenca = row.insertCell();
                const inputPresenca = document.createElement('input');
                inputPresenca.type = 'radio';
                inputPresenca.name = 'frequencia_' + membro.matricula;
                inputPresenca.value = 'presente';
                inputPresenca.checked = true;
                cellPresenca.appendChild(inputPresenca);

                const cellFalta = row.insertCell();
                const inputFalta = document.createElement('input');
                inputFalta.type = 'radio';
                inputFalta.name = 'frequencia_' + membro.matricula;
                inputFalta.value = 'ausente';
                cellFalta.appendChild(inputFalta);
            });

            document.getElementById('frequencia-form').style.display = 'block';
            document.getElementById('form-sessao').style.display = 'none';
        }

        // Função para salvar a frequência
        function salvarFrequencia() {
            const formFrequencia = document.getElementById('form-frequencia');
            
            membros.forEach(membro => {
                const radios = formFrequencia.elements['frequencia_' + membro.matricula];
                sessaoAtualParaFrequencia.frequencia[membro.matricula] = 
                    radios && radios.value === 'presente';
            });

            db.collection("sessoes").add(sessaoAtualParaFrequencia)
                .then(() => {
                    alert(`Sessão ${sessaoAtualParaFrequencia.tipo} salva no Firebase com sucesso!`);

                    document.getElementById('frequencia-form').style.display = 'none';
                    document.getElementById('form-sessao').style.display = 'block';
                    document.getElementById('form-sessao').reset();
                    sessaoAtualParaFrequencia = null;
                })
                .catch((error) => {
                    console.error("Erro ao salvar sessão: ", error);
                    alert("Erro ao salvar a sessão e frequência.");
                });
        }

        // Função para exibir a lista de sessões
        function exibirSessoes() {
            const tbody = document.getElementById('tabela-sessoes').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; 
            
            sessoes.forEach(s => {
                const row = tbody.insertRow();
                row.insertCell().textContent = s.data;
                row.insertCell().textContent = s.tipo;
                const cellAcoes = row.insertCell();
                cellAcoes.textContent = 'Registo Completo'; 
            });
        }
        
        /* --- 5. RELATÓRIOS --- */

        function gerarRelatorioFrequencia() {
            if (sessoes.length === 0) {
                alert('Não há sessões cadastradas para gerar o relatório.');
                return;
            }

            const relatorio = {};
            
            membros.forEach(m => {
                relatorio[m.matricula] = {
                    ...m, 
                    presencas: 0
                };
            });

            const totalSessoes = sessoes.length;

            sessoes.forEach(sessao => {
                for (const matricula in sessao.frequencia) {
                    if (sessao.frequencia[matricula] === true && relatorio[matricula]) {
                        relatorio[matricula].presencas++;
                    }
                }
            });

            const tbody = document.getElementById('tabela-relatorio').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; 

            Object.values(relatorio).forEach(dados => {
                const row = tbody.insertRow();
                const percentagem = (dados.presencas / totalSessoes) * 100;

                row.insertCell().textContent = dados.matricula;
                row.insertCell().textContent = dados.nome;
                row.insertCell().textContent = dados.grau;
                row.insertCell().textContent = dados.presencas;
                row.insertCell().textContent = totalSessoes;
                row.insertCell().textContent = `${percentagem.toFixed(2)}%`; 
            });

            alert('Relatório de Frequência Gerado!');
        }

    </script>
</body>
</html>

