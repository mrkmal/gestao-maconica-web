<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Sessões e Frequência</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="date"], select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        button:hover { background-color: #0056b3; }
        #tabela-frequencia { margin-top: 20px; width: 100%; border-collapse: collapse; }
        #tabela-frequencia th, #tabela-frequencia td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #tabela-frequencia th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html">Voltar ao Menu</a>
        <h1>Registro de Sessões e Frequência</h1>

        <div id="form-sessao">
            <h2>1. Criar Nova Sessão</h2>
            <label for="data-sessao">Data da Sessão:</label>
            <input type="date" id="data-sessao" required>

            <label for="tipo-sessao">Tipo da Sessão:</label>
            <select id="tipo-sessao">
                <option value="Ordinária">Ordinária</option>
                <option value="Extraordinária">Extraordinária</option>
                <option value="Magna">Magna</option>
                <option value="Especial">Especial</option>
            </select>

            <button type="button" onclick="carregarMembros()">Criar Sessão e Carregar Lista</button>
        </div>

        <div id="frequencia-container" style="display:none;">
            <h2>2. Lançar Frequência</h2>
            <p><strong>Sessão de:</strong> <span id="sessao-info"></span></p>
            <form id="form-frequencia">
                <table id="tabela-frequencia">
                    <thead>
                        <tr>
                            <th>Nome do Irmão</th>
                            <th>Grau</th>
                            <th>Presença</th>
                            <th>Falta</th>
                        </tr>
                    </thead>
                    <tbody id="lista-membros">
                        <!-- Membros serão inseridos aqui via JavaScript -->
                    </tbody>
                </table>
                <button type="button" onclick="salvarFrequencia()">Salvar Frequência</button>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCk-L6r_p9SPxx_WmuPnzEMcEAlDfLlbJk",
          authDomain: "gestao-maconica.firebaseapp.com",
          projectId: "gestao-maconica",
          storageBucket: "gestao-maconica.firebasestorage.app",
          messagingSenderId: "57851106083",
          appId: "1:57851106083:web:0572445f0f856d22347296",
          measurementId: "G-F1ZZ7XB7DQ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let membrosCache = []; // Cache para armazenar os dados dos membros

        function carregarMembros() {
            const dataSessao = document.getElementById('data-sessao').value;
            const tipoSessao = document.getElementById('tipo-sessao').value;

            if (!dataSessao) {
                alert('Por favor, selecione a data da sessão.');
                return;
            }

            document.getElementById('sessao-info').innerText = `${dataSessao} (${tipoSessao})`;
            
            const listaMembros = document.getElementById('lista-membros');
            listaMembros.innerHTML = ''; // Limpa a lista anterior
            document.getElementById('frequencia-container').style.display = 'block';

            db.collection("membros").orderBy("nome").get().then((querySnapshot) => {
                membrosCache = []; // Limpa o cache
                querySnapshot.forEach((doc) => {
                    const membro = { id: doc.id, ...doc.data() };
                    membrosCache.push(membro);

                    const row = `<tr>
                                    <td>${membro.nome}</td>
                                    <td>${membro.grau}</td>
                                    <td><input type="radio" name="freq_${membro.id}" value="presente" required></td>
                                    <td><input type="radio" name="freq_${membro.id}" value="ausente"></td>
                                 </tr>`;
                    listaMembros.innerHTML += row;
                });
            }).catch((error) => {
                console.error("Erro ao carregar membros: ", error);
                alert("Erro ao carregar a lista de membros. Verifique o console.");
            });
        }

        function salvarFrequencia() {
            const dataSessao = document.getElementById('data-sessao').value;
            const tipoSessao = document.getElementById('tipo-sessao').value;
            const radios = document.querySelectorAll('#form-frequencia input[type="radio"]:checked');

            if (radios.length < membrosCache.length) {
                alert("Por favor, marque a frequência para todos os irmãos.");
                return;
            }

            const frequencia = {};
            radios.forEach(radio => {
                const membroId = radio.name.split('_')[1];
                frequencia[membroId] = radio.value;
            });

            const sessaoData = {
                data: dataSessao,
                tipo: tipoSessao,
                frequencia: frequencia,
                criadaEm: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("sessoes").add(sessaoData)
            .then((docRef) => {
                alert(`Frequência da sessão de ${dataSessao} salva com sucesso!`);
                document.getElementById('form-sessao').style.display = 'block';
                document.getElementById('frequencia-container').style.display = 'none';
            })
            .catch((error) => {
                console.error("Erro ao salvar frequência: ", error);
                alert("Ocorreu um erro ao salvar os dados. Verifique o console.");
            });
        }
    </script>

</body>
</html>
