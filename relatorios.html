<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Frequência</title>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <a href="/index.html" style="text-decoration: none;"><button style="background-color: #555;">← Voltar ao Menu</button></a>
    <div class="section">
        <h1>Relatórios de Frequência</h1>

        <button onclick="carregarDadosEGerarRelatorio()">Gerar Relatório de Frequência</button>
            
        <table id="tabela-relatorio" style="margin-top: 20px;">
            <thead>
                <tr><th>Matrícula</th><th>Nome</th><th>Grau</th><th>Presenças</th><th>Total de Sessões</th><th>% Frequência</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCk-L6r_p9SPxx_WmuPnzEMcEAlDfLlbJk",
          authDomain: "gestao-maconica.firebaseapp.com",
          projectId: "gestao-maconica",
          storageBucket: "gestao-maconica.firebasestorage.app",
          messagingSenderId: "57851106083",
          appId: "1:57851106083:web:0572445f0f856d22347296",
          measurementId: "G-F1ZZ7XB7DQ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); 

        let membros = [];
        let sessoes = [];
        
        // --- FUNÇÕES DE RELATÓRIO ---

        function carregarDadosParaRelatorio() {
            // Busca todos os membros
            db.collection("membros").get().then((snapshotMembros) => {
                membros = [];
                snapshotMembros.forEach((doc) => {
                    membros.push({ id: doc.id, ...doc.data() });
                });

                // Busca todas as sessões
                db.collection("sessoes").get().then((snapshotSessoes) => {
                    sessoes = [];
                    snapshotSessoes.forEach((doc) => { sessoes.push({ id: doc.id, ...doc.data() }); });
                    // Garante que o relatório só é gerado depois que os dados chegam
                    if (membros.length > 0 && sessoes.length > 0) {
                         gerarRelatorio();
                    } else if (membros.length > 0 && sessoes.length === 0) {
                        alert('Nenhum registro de sessão para calcular.');
                        document.getElementById('tabela-relatorio').getElementsByTagName('tbody')[0].innerHTML = '<tr><td colspan="6">Nenhuma sessão registrada.</td></tr>';
                    } else {
                        alert('Nenhum membro cadastrado.');
                    }
                });
            });
        }
        
        function gerarRelatorio() {
            const relatorio = {};
            const totalSessoes = sessoes.length;

            membros.forEach(m => {
                relatorio[m.matricula] = { 
                    matricula: m.matricula,
                    nome: m.nome,
                    grau: m.nome_grau || m.grau || 'N/A',
                    presencas: 0 
                };
            });

            sessoes.forEach(sessao => {
                for (const matricula in sessao.frequencia) {
                    if (sessao.frequencia[matricula] === true && relatorio[matricula]) {
                        relatorio[matricula].presencas++;
                    }
                }
            });

            exibirRelatorio(relatorio, totalSessoes);
        }

        function exibirRelatorio(dadosRelatorio, totalSessoes) {
            const tbody = document.getElementById('tabela-relatorio').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; 
            
            Object.values(dadosRelatorio).forEach(dados => {
                const row = tbody.insertRow();
                const percentagem = (dados.presencas / totalSessoes) * 100;

                row.insertCell().textContent = dados.matricula;
                row.insertCell().textContent = dados.nome;
                row.insertCell().textContent = dados.grau;
                row.insertCell().textContent = dados.presencas;
                row.insertCell().textContent = totalSessoes;
                row.insertCell().textContent = `${percentagem.toFixed(2)}%`; 
            });
        }


        // --- CHECAGEM DE AUTENTICAÇÃO ---

        auth.onAuthStateChanged((user) => {
            if (user) {
                // Se logado, inicia o carregamento da lista para o relatório
                document.querySelector('button').onclick = carregarDadosParaRelatorio;
            } else {
                window.location.href = "/index.html";
            }
        });

    </script>
</body>
</html>